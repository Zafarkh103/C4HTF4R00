<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"> 
  <title>ZB WhatsApp</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
      display: flex;
      flex-direction: column;
      min-height: 100vh; 
    }
    .chat-container {
      flex-grow: 1;
      padding: 10px;
      overflow-y: auto;
      /* WhatsApp background pattern-like color */
      background-color: #e5ddd5; 
      display: flex;
      flex-direction: column;
      padding-top: 50px; 
      padding-bottom: 70px;
    }
    .chat-header {
        position: fixed;
        top: 0;
        width: 100%;
        /* Dark WhatsApp Green Header */
        background-color: #075e54; 
        color: white;
        padding: 10px 15px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        z-index: 10;
        display: flex;
        align-items: center;
    }
    .status-dot {
        height: 10px;
        width: 10px;
        background-color: gray;
        border-radius: 50%;
        display: inline-block;
        margin-left: 8px;
    }
    .online {
        background-color: #25d366; /* WhatsApp Online Green */
    }
    .message {
      margin-bottom: 12px; /* Increased margin for tail space */
      padding: 10px 14px;
      border-radius: 8px;
      max-width: 80%;
      word-wrap: break-word;
      line-height: 1.5;
      position: relative;
      font-size: 18px;
      box-shadow: 0 1px 0.5px rgba(0, 0, 0, 0.13); /* Slight WhatsApp shadow */
    }
    
    /* --- CHAT BUBBLE TAIL CSS --- */
    /* Sent messages (Right Side) */
    .sent {
      background-color: #dcf8c6;
      align-self: flex-end;
      margin-left: auto;
      /* Right tail position */
      border-top-right-radius: 0; 
    }
    .sent::before {
        content: "";
        position: absolute;
        top: 0;
        right: -10px; /* Position the tail outside */
        border: 5px solid transparent;
        border-top-color: #dcf8c6; /* Match bubble background */
        border-right-color: #dcf8c6;
        filter: drop-shadow(0 1px 0.5px rgba(0, 0, 0, 0.13)); /* Apply bubble shadow to tail */
        transform: rotate(135deg);
    }

    /* Received messages (Left Side) */
    .received {
      background-color: #ffffff;
      align-self: flex-start;
      margin-right: auto;
      /* Left tail position */
      border-top-left-radius: 0; 
    }
    .received::before {
        content: "";
        position: absolute;
        top: 0;
        left: -10px; /* Position the tail outside */
        border: 5px solid transparent;
        border-top-color: #ffffff; /* Match bubble background */
        border-left-color: #ffffff;
        filter: drop-shadow(0 1px 0.5px rgba(0, 0, 0, 0.13)); /* Apply bubble shadow to tail */
        transform: rotate(-135deg);
    }
    /* --- END CHAT BUBBLE TAIL CSS --- */

    .sender-name {
      font-size: 14px;
      color: #777;
      margin-bottom: 2px;
      display: block;
      font-weight: bold; /* Naam ko thora bold kiya */
    }
    .timestamp-tick {
        font-size: 12px;
        color: #929292;
        float: right;
        margin-left: 8px;
        line-height: 1.5;
    }
    /* --- DOUBLE TICK CSS --- */
    .double-tick {
        color: #4fc3f7; /* WhatsApp Blue Read Tick color */
        margin-left: 2px;
        font-weight: bold;
    }
    /* --- END DOUBLE TICK CSS --- */
    .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.3);
        z-index: 20;
        display: none;
    }
    .context-menu-item {
        padding: 10px 20px;
        cursor: pointer;
        font-size: 16px;
        color: #c0392b;
    }
    .context-menu-item:hover {
        background-color: #f0f0f0;
    }
    .input-area {
      display: flex;
      padding: 8px; /* Thora sa kam padding */
      /* Light grey ya thora sa white look */
      background-color: #f6f6f6; 
      position: fixed;
      bottom: 0;
      width: 100%;
      box-sizing: border-box;
      align-items: center;
    }
    #messageInput {
      flex-grow: 1;
      padding: 12px;
      border-radius: 20px;
      border: none;
      margin-right: 8px;
      font-size: 18px;
      background-color: white;
    }
    #sendButton {
      width: 45px;
      height: 45px;
      border: none;
      border-radius: 50%;
      /* WhatsApp Send Button Green */
      background-color: #128c7e; 
      color: white;
      cursor: pointer;
      font-size: 20px;
      line-height: 45px;
      text-align: center;
      display: flex;
      justify-content: center;
      align-items: center;
      flex-shrink: 0;
    }

    /* Name Modal Styles (Same, already good) */
    #nameModal {
        display: none; 
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.7);
        z-index: 100;
        justify-content: center;
        align-items: center;
    }
    .modal-content {
        background-color: #fff;
        padding: 30px;
        border-radius: 10px;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        max-width: 300px;
        width: 90%;
        animation: fadeIn 0.3s ease-out;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    #nameInput {
        width: 100%;
        padding: 10px;
        margin: 15px 0;
        border: 2px solid #ccc;
        border-radius: 6px;
        box-sizing: border-box;
        font-size: 16px;
    }
    #submitName {
        /* WhatsApp Green for Button */
        background-color: #128c7e; 
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 20px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.3s;
    }
    #submitName:hover {
        background-color: #075e54;
    }
  </style>
</head>
<body>
  
  <div id="nameModal" style="display: none;">
    <div class="modal-content">
      <h2>üõ°Ô∏èONLY CHAT NO SPAMüõ°Ô∏è</h2>
      <p>Enter Real Name ? (Enter your Real name to continue)</p>
      <input type="text" id="nameInput" placeholder="Enter Real Name likhein (e.g., Zafar/Zohaib)">
      <button id="submitName">Chat Shuru Karein</button>
    </div>
  </div>

  <div class="chat-header">
    ZB WhatsApp 
    <span id="otherUserStatus" class="status-dot"></span>
    <span id="statusText" style="font-size: 14px; margin-left: 5px;">Only For Messages</span>
  </div>

  <div class="chat-container" id="messages">
  </div>

  <div id="contextMenu" class="context-menu">
    <div class="context-menu-item" id="deleteOption">Delete Message</div>
  </div>

  <div class="input-area">
    <input type="text" id="messageInput" placeholder="Type a message...">
    <button id="sendButton">‚û§</button>
  </div>
  
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>                                                             
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>                                                                  
  <script>
                                   
    const firebaseConfig = {
      apiKey: "AIzaSyB8zMhCjGxmHBpruABYA4pBj3jU0uMHCs0",
      authDomain: "zafi-chat-app.firebaseapp.com",
      projectId: "zafi-chat-app",
      storageBucket: "zafi-chat-app.firebasestorage.app",
      messagingSenderId: "989950346714",
      appId: "1:989950346714:web:7bad7f8fae2a72ce0bace3",
      measurementId: "G-XW5MS2D2K7",
      databaseURL: "https://zafi-chat-app-default-rtdb.asia-southeast1.firebasedatabase.app" 
    };
                     
    const app = firebase.initializeApp(firebaseConfig);
    const database = app.database();
    const auth = app.auth();
                                                 
    let currentUserId = null;
    let currentUserName = null; 
    let otherUserId = 'zohaib_fixed_id'; // Hardcoded for fixed chat partner
    
    // --- MODAL ELEMENTS ---
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const submitNameButton = document.getElementById('submitName');
    
    // --- FIREBASE REFERENCES ---
    const messagesRef = database.ref('messages');
    const messagesDiv = document.getElementById('messages');
    const messageInput = document.getElementById('messageInput');
    const contextMenu = document.getElementById('contextMenu');
    const deleteOption = document.getElementById('deleteOption');

    
    // --- MAIN SIGN-IN LOGIC ---
    auth.signInAnonymously()
      .then(async (userCredential) => {
        currentUserId = userCredential.user.uid;
        console.log("Current User ID:", currentUserId);
        
        const userRef = database.ref('users/' + currentUserId);
        const nameSnapshot = await userRef.child('displayName').once('value');
        
        if (nameSnapshot.exists()) {
            currentUserName = nameSnapshot.val();
            setupUserStatus(currentUserId);
            startMessageListener(); 
        } else {
            nameModal.style.display = 'flex';
            nameInput.focus(); 
        }
        
      })
      .catch((error) => {
        console.error("Sign-in error:", error);
      });

    // --- MODAL SUBMIT LOGIC ---
    function handleNameSubmission() {
        let name = nameInput.value;
        
        if (!name || name.trim() === "") {
            alert("Naam zaroor dein taake doosre aapko pehchaan saken.");
            return;
        }
        
        currentUserName = name.trim();
        const userRef = database.ref('users/' + currentUserId);
        userRef.child('displayName').set(currentUserName)
            .then(() => {
                nameModal.style.display = 'none';
                console.log("Current User Name set:", currentUserName);
                
                setupUserStatus(currentUserId);
                startMessageListener();
            })
            .catch(error => console.error("Error saving name:", error));
    }

    submitNameButton.addEventListener('click', handleNameSubmission);
    nameInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            handleNameSubmission();
        }
    });

    
    // --- NEW FEATURE 1: Online/Typing Status Logic ---
    function setupUserStatus(uid) {
        const userStatusRef = database.ref('status/' + uid);
        
        const isOnline = { state: 'online', isTyping: false, last_seen: firebase.database.ServerValue.TIMESTAMP };
        const isOffline = { state: 'offline', isTyping: false, last_seen: firebase.database.ServerValue.TIMESTAMP };
        
        userStatusRef.onDisconnect().set(isOffline).then(() => {
            userStatusRef.set(isOnline);
        });

        // Add event listeners for Typing Indicator
        let typingTimeout;
        const setTypingStatus = (isTyping) => {
            userStatusRef.update({ isTyping: isTyping });
        };

        messageInput.addEventListener('input', () => {
            setTypingStatus(true);
            clearTimeout(typingTimeout);
            // Agar 3 seconds tak typing ruk jaye toh isTyping: false kardo
            typingTimeout = setTimeout(() => {
                setTypingStatus(false);
            }, 3000); 
        });


        // Other user status listener
        database.ref('status/' + otherUserId).on('value', (snapshot) => {
            const status = snapshot.val();
            const dot = document.getElementById('otherUserStatus');
            const text = document.getElementById('statusText');
            
            if (status) {
                if (status.isTyping) {
                    dot.classList.add('online');
                    text.textContent = 'Typing...';
                }
                else if (status.state === 'online') {
                    dot.classList.add('online');
                    text.textContent = 'Online';
                } else {
                    dot.classList.remove('online');
                    if (status.last_seen) {
                        const date = new Date(status.last_seen);
                        text.textContent = 'Last seen: ' + date.toLocaleTimeString();
                    } else {
                        text.textContent = 'Offline';
                    }
                }
            } else {
                 dot.classList.remove('online');
                 text.textContent = 'Offline';
            }
        });
    }

    // --- MESSAGE SEND/DELETE SETUP ---
    document.getElementById('sendButton').addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    document.addEventListener('click', () => {
        contextMenu.style.display = 'none';
    });

    function sendMessage() {
      const messageText = messageInput.value;
      
      if (messageText.trim() === "" || !currentUserId || !currentUserName) {
        if (!currentUserName) {
            nameModal.style.display = 'flex';
            nameInput.focus();
        }
        return;
      }
                                      
      messagesRef.push({
        text: messageText,
        senderId: currentUserId,
        senderName: currentUserName, 
        timestamp: Date.now()
      });
      messageInput.value = '';
      
      // Typing status ko immediately false kar do message bhejne ke baad
      database.ref('status/' + currentUserId).update({ isTyping: false });
    }
    
    // --- Message Delete Logic ---
    let messageKeyToDelete = null;

    deleteOption.addEventListener('click', () => {
        if (messageKeyToDelete) {
            messagesRef.child(messageKeyToDelete).remove()
                .then(() => {
                    console.log("Message successfully deleted:", messageKeyToDelete);
                    messageKeyToDelete = null; 
                    contextMenu.style.display = 'none';
                })
                .catch((error) => {
                    console.error("Error deleting message:", error);
                    alert("Message delete nahi ho saka.");
                });
        }
    });

    function showContextMenu(e, key) {
        e.preventDefault(); 
        e.stopPropagation(); 

        contextMenu.style.display = 'block';
        
        contextMenu.style.left = e.clientX + 'px';
        contextMenu.style.top = e.clientY + 'px';
        
        if (e.clientX + contextMenu.offsetWidth > window.innerWidth) {
            contextMenu.style.left = window.innerWidth - contextMenu.offsetWidth - 10 + 'px';
        }
        if (e.clientY + contextMenu.offsetHeight > window.innerHeight) {
            contextMenu.style.top = window.innerHeight - contextMenu.offsetHeight - 10 + 'px';
        }

        messageKeyToDelete = key;
    }

    // --- Message Display Logic ---
    function startMessageListener() {
        messagesRef.on('value', (snapshot) => {
            messagesDiv.innerHTML = '';
            snapshot.forEach((childSnapshot) => {
                const message = childSnapshot.val();
                const messageKey = childSnapshot.key;
                const isSentByMe = (message.senderId === currentUserId);
                
                const senderName = message.senderName || (isSentByMe ? "Unknown (Me)" : "Unknown (Other)");
                
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', isSentByMe ? 'sent' : 'received');
                
                const time = new Date(message.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                // --- DOUBLE TICK IMPLEMENTATION (Visual) ---
                // Sent messages ke liye ab Double Tick dikhega.
                const tickHtml = isSentByMe ? 
                    `<span class="timestamp-tick">${time} ‚úì<span class="double-tick">‚úì</span></span>` 
                    : ''; 
                // Note: Blue color ke liye aapko timestamp-tick aur double-tick CSS adjust karni hogi.
                
                messageElement.innerHTML = `
                    <span class="sender-name">${senderName}</span>
                    ${message.text}
                    ${tickHtml}
                `;
                
                // --- ADD DELETE EVENT LISTENERS ---
                if (isSentByMe) {
                    messageElement.addEventListener('contextmenu', (e) => {
                        showContextMenu(e, messageKey);
                    });
                    
                    let pressTimer;
                    messageElement.addEventListener('touchstart', (e) => {
                        e.stopPropagation(); 
                        pressTimer = setTimeout(() => {
                            showContextMenu(e, messageKey);
                        }, 800); 
                    });
                    messageElement.addEventListener('touchend', () => {
                        clearTimeout(pressTimer);
                    });
                    messageElement.addEventListener('touchmove', () => {
                        clearTimeout(pressTimer);
                    });
                }
                
                messagesDiv.appendChild(messageElement);
            });
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });
    }
  </script>
</body>
</html>
