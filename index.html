<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>AnimeChat Pro - ZAFAR Rooms</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;margin:0;padding:0;background:#000;color:#fff;width:100%;height:100vh;overflow:hidden}
    .anime-bg{position:fixed;top:0;left:0;width:100%;height:100%;z-index:-2;background:#000 url('background.png') center/cover;opacity:0.5;filter:brightness(0.8) contrast(1.3) saturate(1.5)}
    .red-light{position:fixed;top:0;left:0;width:100%;height:100%;background:radial-gradient(circle at 20% 50%,rgba(255,45,45,0.4) 0%,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,20,20,0.3) 0%,transparent 50%);z-index:-1;mix-blend-mode:screen}
    
    /* HEADER IMPROVED */
    .chat-header{position:fixed;top:0;width:100%;background:rgba(0,0,0,0.95);backdrop-filter:blur(20px);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;border-bottom:2px solid rgba(255,45,45,0.4);z-index:100;height:64px;box-sizing:border-box;box-shadow:0 5px 25px rgba(0,0,0,0.7)}
    .header-left{display:flex;align-items:center;gap:15px}
    .logo{width:44px;height:44px;border-radius:12px;overflow:hidden;border:3px solid #ff2d2d;background:linear-gradient(135deg,#ff2d2d,#b30000);display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 0 25px rgba(255,45,45,0.8);animation:logoGlow 3s infinite alternate}
    @keyframes logoGlow{0%{box-shadow:0 0 20px rgba(255,45,45,0.6)}100%{box-shadow:0 0 30px rgba(255,45,45,1)}}
    .header-text h2{margin:0 0 3px 0;font-size:20px;color:#ff2d2d;text-shadow:0 0 15px rgba(255,45,45,0.8);font-weight:800;letter-spacing:0.5px}
    .header-text small{font-size:12px;color:#25d366;font-weight:600;display:flex;align-items:center;gap:6px}
    .online-dot{display:inline-block;width:8px;height:8px;background:#25d366;border-radius:50%;animation:pulse 2s infinite}
    @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:0.7;transform:scale(1.2)}}
    
    /* CHAT CONTAINER */
    .chat-container{position:fixed;top:64px;bottom:116px;width:100%;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:15px;box-sizing:border-box;scroll-behavior:smooth}
    .messages{display:flex;flex-direction:column;gap:14px;min-height:100%}
    
    /* MESSAGES IMPROVED */
    .message{max-width:78%;padding:16px 20px;border-radius:22px;position:relative;word-wrap:break-word;backdrop-filter:blur(10px);animation:fadeInUp 0.4s ease-out;border:1.5px solid rgba(255,255,255,0.15);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(15px)}to{opacity:1;transform:translateY(0)}}
    .sent{align-self:flex-end;background:linear-gradient(135deg,#0084ff,#0066cc,#0044aa);color:#fff;border-bottom-right-radius:10px;box-shadow:0 6px 25px rgba(0,132,255,0.5);border:1.5px solid rgba(0,132,255,0.3)}
    .received{align-self:flex-start;background:rgba(255,255,255,0.12);border:1.5px solid rgba(255,255,255,0.2);border-bottom-left-radius:10px}
    .sender-name{font-size:13px;font-weight:700;margin-bottom:6px;opacity:0.95;display:flex;justify-content:space-between;align-items:center}
    .sender-name .user-badge{display:flex;align-items:center;gap:8px}
    .user-avatar-small{width:24px;height:24px;border-radius:50%;background:linear-gradient(135deg,#ff2d2d,#b30000);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;border:2px solid rgba(255,255,255,0.3)}
    .message-time{font-size:11px;opacity:0.7;background:rgba(0,0,0,0.3);padding:2px 8px;border-radius:10px}
    
    /* INPUT AREA IMPROVED - FILE SHARE BUTTON REMOVED */
    .input-area{position:fixed;bottom:58px;width:100%;padding:15px 18px;background:rgba(0,0,0,0.97);backdrop-filter:blur(20px);border-top:2px solid rgba(255,45,45,0.3);display:flex;gap:12px;z-index:100;box-sizing:border-box;box-shadow:0 -5px 25px rgba(0,0,0,0.8)}
    #messageInput{flex:1;padding:15px 22px;border-radius:28px;border:none;background:rgba(255,255,255,0.13);color:#fff;font-size:16px;outline:none;border:2px solid rgba(255,45,45,0.4);transition:all 0.3s;font-weight:500}
    #messageInput::placeholder{color:rgba(255,255,255,0.6)}
    #messageInput:focus{border-color:#ff2d2d;box-shadow:0 0 20px rgba(255,45,45,0.5);background:rgba(255,255,255,0.16)}
    #sendButton{width:50px;height:50px;border-radius:50%;border:none;background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(255,45,45,0.7);transition:all 0.3s;position:relative;overflow:hidden}
    #sendButton:hover{transform:scale(1.08);box-shadow:0 8px 30px rgba(255,45,45,0.9)}
    #sendButton:active{transform:scale(0.95)}
    
    /* HIDE ANY FILE UPLOAD BUTTONS */
    .file-upload-btn, .upload-icon, input[type="file"] {
      display: none !important;
      width: 0 !important;
      height: 0 !important;
      opacity: 0 !important;
      position: absolute !important;
      pointer-events: none !important;
    }
    
    /* NAV BAR IMPROVED */
    .nav-bar{position:fixed;bottom:0;width:100%;background:rgba(0,0,0,0.98);backdrop-filter:blur(20px);display:flex;height:58px;border-top:2px solid rgba(255,45,45,0.3);z-index:100;box-shadow:0 -5px 25px rgba(0,0,0,0.9)}
    .nav-item{flex:1;text-align:center;color:rgba(255,255,255,0.7);font-size:12px;cursor:pointer;display:flex;flex-direction:column;justify-content:center;align-items:center;transition:all 0.3s;position:relative}
    .nav-item:hover{color:rgba(255,255,255,0.9);background:rgba(255,45,45,0.05)}
    .nav-item.active{color:#ff2d2d;text-shadow:0 0 15px rgba(255,45,45,0.8);background:rgba(255,45,45,0.1)}
    .nav-item.active::after{content:'';position:absolute;bottom:0;left:25%;right:25%;height:3px;background:#ff2d2d;border-radius:3px 3px 0 0}
    .nav-icon{font-size:24px;margin-bottom:4px;transition:all 0.3s}
    .nav-item.active .nav-icon{transform:scale(1.15)}
    
    /* SIDEBARS IMPROVED */
    .sidebar,.online-sidebar{position:fixed;top:0;width:300px;height:100%;background:rgba(0,0,0,0.99);backdrop-filter:blur(30px);z-index:1000;transition:transform 0.4s cubic-bezier(0.25,0.46,0.45,0.94);overflow-y:auto;padding:25px;box-sizing:border-box;box-shadow:0 0 50px rgba(0,0,0,0.9)}
    .sidebar{left:0;transform:translateX(-100%);border-right:3px solid rgba(255,45,45,0.4)}
    .sidebar.show{transform:translateX(0)}
    .online-sidebar{right:0;transform:translateX(100%);border-left:3px solid rgba(0,132,255,0.4)}
    .online-sidebar.show{transform:translateX(0)}
    
    /* CHATROOMS IMPROVED */
    .chatroom{display:flex;align-items:center;gap:15px;padding:15px;margin-bottom:12px;background:rgba(255,255,255,0.06);border-radius:15px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;position:relative}
    .chatroom:hover{background:rgba(255,45,45,0.18);border-color:rgba(255,45,45,0.6);transform:translateX(5px)}
    .chatroom.active{background:rgba(255,45,45,0.25);border-color:rgba(255,45,45,0.9);box-shadow:0 8px 25px rgba(255,45,45,0.3);transform:translateX(8px)}
    .room-avatar{width:55px;height:55px;border-radius:12px;background:linear-gradient(135deg,#ff2d2d,#b30000);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:bold;box-shadow:0 5px 15px rgba(255,45,45,0.5);border:2px solid rgba(255,255,255,0.2)}
    .room-info h4{margin:0 0 5px 0;font-size:16px;display:flex;align-items:center;gap:8px}
    .room-info small{font-size:11px;opacity:0.8;background:rgba(255,255,255,0.08);padding:3px 10px;border-radius:10px;border:1px dashed rgba(255,255,255,0.2)}
    
    /* ONLINE USERS WITH PROFILE IMAGES */
    .online-user{display:flex;align-items:center;gap:15px;padding:14px;margin-bottom:10px;background:rgba(255,255,255,0.07);border-radius:14px;border-left:4px solid #25d366;transition:all 0.3s;border:1px solid rgba(255,255,255,0.1)}
    .online-user:hover{background:rgba(37,211,102,0.15);transform:translateX(5px)}
    .user-avatar{width:48px;height:48px;border-radius:50%;background:linear-gradient(135deg,#0084ff,#0066cc);display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:20px;border:3px solid rgba(255,255,255,0.3);box-shadow:0 5px 15px rgba(0,132,255,0.4);position:relative}
    .user-avatar::after{content:'';position:absolute;bottom:2px;right:2px;width:12px;height:12px;background:#25d366;border-radius:50%;border:2px solid #000}
    .user-info{flex:1}
    .user-info strong{display:block;font-size:15px;margin-bottom:3px}
    .user-info small{font-size:12px;opacity:0.8;display:flex;align-items:center;gap:5px}
    .room-indicator{background:rgba(255,45,45,0.15);padding:2px 8px;border-radius:8px;font-size:10px;border:1px solid rgba(255,45,45,0.3)}
    
    /* STICKER MENU IMPROVED */
    .sticker-menu{position:fixed;bottom:116px;left:12px;right:12px;background:rgba(0,0,0,0.99);border:3px solid rgba(255,45,45,0.6);border-radius:20px;z-index:1000;display:none;flex-direction:column;max-height:380px;box-shadow:0 15px 40px rgba(255,45,45,0.6);overflow:hidden}
    .sticker-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:2px solid rgba(255,45,45,0.4);background:rgba(255,45,45,0.2);border-radius:20px 20px 0 0}
    .sticker-header h3{margin:0;color:#ff2d2d;font-size:18px;text-shadow:0 0 15px rgba(255,45,45,0.8);font-weight:700}
    .close-sticker-menu{background:none;border:none;color:#ff2d2d;font-size:24px;cursor:pointer;width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;transition:all 0.3s}
    .close-sticker-menu:hover{background:rgba(255,45,45,0.4);transform:rotate(90deg) scale(1.1)}
    .sticker-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:15px;padding:20px;overflow-y:auto}
    .sticker-item{background:rgba(255,255,255,0.08);border-radius:16px;padding:14px;cursor:pointer;transition:all 0.3s;border:2px solid transparent;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .sticker-item:hover{background:rgba(255,45,45,0.25);border-color:rgba(255,45,45,0.9);transform:scale(1.12) rotate(2deg);box-shadow:0 10px 25px rgba(255,45,45,0.5)}
    .sticker-item::after{content:attr(title);position:absolute;bottom:5px;left:0;right:0;font-size:10px;color:rgba(255,255,255,0.8);text-align:center;background:rgba(0,0,0,0.7);padding:3px;border-radius:5px;opacity:0;transition:opacity 0.3s}
    .sticker-item:hover::after{opacity:1}
    .sticker-item img{width:65px;height:65px;object-fit:contain;pointer-events:none;transition:transform 0.3s}
    .sticker-item:hover img{transform:scale(1.1)}
    .sticker-btn{background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;border:none;border-radius:50%;width:46px;height:46px;font-size:22px;cursor:pointer;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 20px rgba(255,45,45,0.7);transition:all 0.3s}
    .sticker-btn:hover{transform:scale(1.1) rotate(10deg);box-shadow:0 10px 25px rgba(255,45,45,0.9)}
    
    /* MODALS IMPROVED */
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.97);z-index:2000;align-items:center;justify-content:center;backdrop-filter:blur(15px);animation:modalFadeIn 0.3s ease}
    @keyframes modalFadeIn{from{opacity:0;backdrop-filter:blur(0)}to{opacity:1;backdrop-filter:blur(15px)}}
    .modal-content{background:rgba(15,5,10,0.99);padding:30px;border-radius:20px;width:90%;max-width:380px;border:3px solid rgba(255,45,45,0.6);box-shadow:0 0 50px rgba(255,45,45,0.4);text-align:center;animation:modalSlideUp 0.4s cubic-bezier(0.25,0.46,0.45,0.94)}
    @keyframes modalSlideUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}
    .modal-content h2{margin:0 0 15px 0;color:#ff2d2d;font-size:26px;text-shadow:0 0 15px rgba(255,45,45,0.7)}
    .modal-content p{color:rgba(255,255,255,0.9);margin-bottom:20px;font-size:15px}
    .modal-content input{width:100%;padding:16px 20px;margin:18px 0;border-radius:14px;border:2px solid rgba(255,45,45,0.5);background:rgba(0,0,0,0.6);color:#fff;font-size:16px;box-sizing:border-box;transition:all 0.3s;font-weight:500}
    .modal-content input:focus{border-color:#ff2d2d;box-shadow:0 0 20px rgba(255,45,45,0.5);background:rgba(0,0,0,0.7)}
    .modal-content button{background:linear-gradient(135deg,#ff2d2d,#b30000);color:#fff;border:none;padding:16px 30px;border-radius:14px;font-size:16px;cursor:pointer;width:100%;margin-top:15px;box-shadow:0 6px 20px rgba(255,45,45,0.5);transition:all 0.3s;font-weight:600;letter-spacing:0.5px}
    .modal-content button:hover{transform:translateY(-2px);box-shadow:0 10px 25px rgba(255,45,45,0.7)}
    .modal-content button:active{transform:translateY(0)}
    
    /* SECRET CONTAINER */
    .secret-container{position:fixed;top:75px;right:12px;background:rgba(0,0,0,0.99);padding:18px;border-radius:14px;border:3px solid #ff2d2d;display:none;box-shadow:0 0 35px rgba(255,45,45,0.4);max-width:270px;z-index:1000;animation:slideInRight 0.3s ease}
    @keyframes slideInRight{from{opacity:0;transform:translateX(20px)}to{opacity:1;transform:translateX(0)}}
    
    /* LOADING */
    .loading{text-align:center;padding:25px;color:rgba(255,255,255,0.7);font-size:15px}
    .loading::after{content:'...';animation:dots 1.5s infinite}
    @keyframes dots{0%,20%{content:'.'}40%{content:'..'}60%,100%{content:'...'}}
    
    /* RESPONSIVE */
    @media (max-width:768px){
      .sidebar,.online-sidebar{width:88%}
      .chat-container{padding:12px}
      .message{max-width:82%;padding:14px 18px}
      .sticker-grid{grid-template-columns:repeat(4,1fr);gap:12px;padding:16px}
      .sticker-item img{width:55px;height:55px}
      .chat-header{padding:12px 15px;height:62px}
      .header-text h2{font-size:18px}
      .logo{width:40px;height:40px;font-size:22px}
      .input-area{padding:14px 16px}
      #messageInput{padding:14px 20px;font-size:15px}
    }
    @media (max-width:480px){
      .sticker-grid{grid-template-columns:repeat(3,1fr)}
      .header-text h2{font-size:16px}
      .nav-icon{font-size:22px}
      .user-avatar{width:42px;height:42px;font-size:18px}
      .room-avatar{width:48px;height:48px;font-size:20px}
    }
  </style>
</head>
<body>
  <div class="anime-bg" id="animeBg"></div>
  <div class="red-light"></div>
  
  <div class="sticker-menu" id="stickerMenu">
    <div class="sticker-header">
      <h3><i class="fas fa-sticky-note"></i> Anime Stickers Pack</h3>
      <button class="close-sticker-menu" id="closeStickerMenu">‚úï</button>
    </div>
    <div class="sticker-grid" id="stickerGrid"></div>
  </div>
  
  <div class="secret-container" id="secretContainer">
    <h4 style="margin:0 0 12px;color:#ff2d2d;text-align:center"><i class="fas fa-lock"></i> Secret Passwords</h4>
    <div style="font-size:13px;line-height:1.7">
      <div><strong><i class="fas fa-door-closed"></i> Room 1:</strong> <span id="secretPass1" style="color:#25d366;font-weight:bold">Loading...</span></div>
      <div><strong><i class="fas fa-door-closed"></i> Room 2:</strong> <span id="secretPass2" style="color:#25d366;font-weight:bold">Loading...</span></div>
      <div><strong><i class="fas fa-door-closed"></i> Room 3:</strong> <span id="secretPass3" style="color:#25d366;font-weight:bold">Loading...</span></div>
      <div><strong><i class="fas fa-door-closed"></i> Room 4:</strong> <span id="secretPass4" style="color:#25d366;font-weight:bold">Loading...</span></div>
      <div><strong><i class="fas fa-door-closed"></i> Room 5:</strong> <span id="secretPass5" style="color:#25d366;font-weight:bold">Loading...</span></div>
    </div>
    <button onclick="hideSecretPanel()" style="margin-top:12px;background:#ff2d2d;color:#fff;border:none;padding:8px 15px;border-radius:10px;font-size:12px;cursor:pointer;width:100%;font-weight:600;transition:all 0.3s">Close <i class="fas fa-times"></i></button>
  </div>
  
  <div class="chat-header">
    <div class="header-left">
      <button id="menuBtn" style="background:none;border:none;color:#ff2d2d;font-size:24px;cursor:pointer;transition:all 0.3s" title="Rooms Menu"><i class="fas fa-bars"></i></button>
      <div class="logo"><i class="fas fa-robot"></i></div>
      <div class="header-text">
        <h2><i class="fas fa-comment-dots"></i> AnimeChat Pro</h2>
        <small><span class="online-dot"></span> <span id="onlineCount">0 online</span></small>
      </div>
    </div>
    <div id="roomNameDisplay" style="color:#ff2d2d;font-weight:bold;font-size:15px;max-width:110px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;background:rgba(255,45,45,0.1);padding:6px 12px;border-radius:10px;border:1px solid rgba(255,45,45,0.3)">General Chat</div>
    <div style="display:flex;align-items:center;gap:12px">
      <button id="onlineBtn" style="background:none;border:none;color:#25d366;font-size:22px;cursor:pointer;transition:all 0.3s" title="Online Users"><i class="fas fa-users"></i></button>
      <button id="secretBtn" style="background:none;border:none;color:#ff2d2d;font-size:22px;cursor:pointer;transition:all 0.3s" title="Secret Passwords"><i class="fas fa-eye"></i></button>
    </div>
  </div>
  
  <div class="chat-container" id="chatContainer">
    <div class="messages" id="messages"><div class="loading" id="loading">Loading messages</div></div>
  </div>
  
  <div class="input-area">
    <!-- ONLY STICKER BUTTON, INPUT AND SEND BUTTON - NO FILE UPLOAD -->
    <button class="sticker-btn" id="stickerBtn" title="Stickers"><i class="fas fa-sticky-note"></i></button>
    <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off">
    <button id="sendButton" title="Send Message"><i class="fas fa-paper-plane"></i></button>
  </div>
  
  <div class="nav-bar">
    <div class="nav-item active" data-tab="chat"><div class="nav-icon"><i class="fas fa-comment-alt"></i></div><div>Chat</div></div>
    <div class="nav-item" data-tab="rooms"><div class="nav-icon"><i class="fas fa-door-closed"></i></div><div>Rooms</div></div>
    <div class="nav-item" data-tab="theme"><div class="nav-icon"><i class="fas fa-palette"></i></div><div>Theme</div></div>
    <div class="nav-item" data-tab="online"><div class="nav-icon"><i class="fas fa-user-friends"></i></div><div><span id="onlineBadge">0</span> Online</div></div>
  </div>
  
  <div class="sidebar" id="sidebar">
    <h3 style="margin-top:0;color:#ff2d2d;text-align:center;font-size:22px"><i class="fas fa-lock"></i> Secret Rooms</h3>
    <div class="chatroom active" data-room="general" data-bg="background.png"><div class="room-avatar"><i class="fas fa-globe"></i></div><div class="room-info"><h4>General Chat <span style="color:#25d366"><i class="fas fa-unlock"></i></span></h4><small>Public ‚Ä¢ Everyone welcome</small></div></div>
    <div class="chatroom" data-room="Chatroom1" data-password="ZAFAR1" data-bg="bg1.png"><div class="room-avatar"><i class="fas fa-1"></i></div><div class="room-info"><h4>Secret Room 1 <span style="color:#ff2d2d"><i class="fas fa-lock"></i></span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.15);padding:4px 10px;border-radius:12px;border:2px dashed rgba(255,45,45,0.4)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom2" data-password="ZAFAR2" data-bg="bg2.png"><div class="room-avatar"><i class="fas fa-2"></i></div><div class="room-info"><h4>Secret Room 2 <span style="color:#ff2d2d"><i class="fas fa-lock"></i></span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.15);padding:4px 10px;border-radius:12px;border:2px dashed rgba(255,45,45,0.4)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom3" data-password="ZAFAR3" data-bg="bg3.png"><div class="room-avatar"><i class="fas fa-3"></i></div><div class="room-info"><h4>Secret Room 3 <span style="color:#ff2d2d"><i class="fas fa-lock"></i></span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.15);padding:4px 10px;border-radius:12px;border:2px dashed rgba(255,45,45,0.4)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom4" data-password="ZAFAR4" data-bg="bg4.png"><div class="room-avatar"><i class="fas fa-4"></i></div><div class="room-info"><h4>Secret Room 4 <span style="color:#ff2d2d"><i class="fas fa-lock"></i></span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.15);padding:4px 10px;border-radius:12px;border:2px dashed rgba(255,45,45,0.4)">Password Protected</small></div></div>
    <div class="chatroom" data-room="Chatroom5" data-password="ZAFAR5" data-bg="bg5.png"><div class="room-avatar"><i class="fas fa-5"></i></div><div class="room-info"><h4>Secret Room 5 <span style="color:#ff2d2d"><i class="fas fa-lock"></i></span></h4><small style="color:#ff2d2d;background:rgba(255,45,45,0.15);padding:4px 10px;border-radius:12px;border:2px dashed rgba(255,45,45,0.4)">Password Protected</small></div></div>
  </div>
  
  <div class="online-sidebar" id="onlineSidebar">
    <h3 style="margin-top:0;color:#25d366;text-align:center;font-size:22px"><i class="fas fa-users"></i> Online Users</h3>
    <div id="onlineUsersList"><div class="loading">Loading users</div></div>
  </div>
  
  <div class="modal" id="nameModal">
    <div class="modal-content">
      <h2><i class="fas fa-robot"></i> Welcome to AnimeChat</h2>
      <p>Enter your name to start chatting:</p>
      <input type="text" id="nameInput" placeholder="Enter your name..." autocomplete="off" maxlength="20">
      <button id="submitName"><i class="fas fa-rocket"></i> Start Chatting</button>
      <p style="font-size:13px;margin-top:20px;opacity:0.8;line-height:1.6"><i class="fas fa-bolt" style="color:#ff2d2d"></i> Real-time Chat<br><i class="fas fa-lock" style="color:#ff2d2d"></i> 5 password protected rooms<br><i class="fas fa-sticky-note" style="color:#ff2d2d"></i> 10 FREE Anime Stickers<br><i class="fas fa-user-friends" style="color:#ff2d2d"></i> Live Online Users</p>
    </div>
  </div>
  
  <div class="modal" id="passwordModal">
    <div class="modal-content">
      <h2><i class="fas fa-lock"></i> Password Required</h2>
      <p id="roomPrompt">Enter password for this room:</p>
      <input type="password" id="passwordInput" placeholder="Enter password..." autocomplete="off">
      <button id="submitPassword"><i class="fas fa-key"></i> Join Room</button>
      <button id="cancelPassword" style="background:rgba(255,255,255,0.12);margin-top:8px"><i class="fas fa-times"></i> Cancel</button>
    </div>
  </div>

<script>
// ========== CONFIG ==========
const CONFIG = {
  SECRET_PASSWORDS: {
    "Chatroom1": "ZAFAR1",
    "Chatroom2": "ZAFAR2", 
    "Chatroom3": "ZAFAR3",
    "Chatroom4": "ZAFAR4",
    "Chatroom5": "ZAFAR5"
  },
  
  STICKERS: [
    { id: 1, name: "Gojo Satoru", file: "sticker1.png" },
    { id: 2, name: "Nezuko Kamado", file: "sticker2.png" },
    { id: 3, name: "Luffy", file: "sticker3.png" },
    { id: 4, name: "Sailor Moon", file: "sticker4.png" },
    { id: 5, name: "Tanjiro", file: "sticker5.png" },
    { id: 6, name: "Pikachu", file: "sticker6.png" },
    { id: 7, name: "Kakashi", file: "sticker7.png" },
    { id: 8, name: "Mikasa", file: "sticker8.png" },
    { id: 9, name: "Totoro", file: "sticker9.png" },
    { id: 10, name: "Anya Forger", file: "sticker10.png" }
  ],
  
  FIREBASE_CONFIG: {
    apiKey: "AIzaSyB8zMhCjGxmHBpruABYA4pBj3jU0uMHCs0",
    authDomain: "zafi-chat-app.firebaseapp.com",
    projectId: "zafi-chat-app",
    storageBucket: "zafi-chat-app.firebasestorage.app",
    messagingSenderId: "989950346714",
    appId: "1:989950346714:web:7bad7f8fae2a72ce0bace3",
    measurementId: "G-XW5MS2D2K7",
    databaseURL: "https://zafi-chat-app-default-rtdb.asia-southeast1.firebasedatabase.app"
  },
  
  // NEW: Profile images for users
  USER_IMAGES: [
    "üë§", "üê±", "üêâ", "‚öîÔ∏è", "üõ°Ô∏è", "üé≠", "üëë", "üéÆ", "üé®", "üåü",
    "üî•", "üíß", "üå™Ô∏è", "‚ö°", "üåô", "‚òÄÔ∏è", "‚≠ê", "üå†", "üé™", "üéØ"
  ]
};

// ========== STATE ==========
let currentUser = {
  name: '',
  id: '',
  room: 'general',
  profileIcon: 'üë§' // NEW: Profile icon
};

let app = {
  firebase: null,
  database: null,
  auth: null
};

// ========== ELEMENTS ==========
const elements = {
  chatContainer: document.getElementById('chatContainer'),
  messages: document.getElementById('messages'),
  messageInput: document.getElementById('messageInput'),
  sendButton: document.getElementById('sendButton'),
  stickerBtn: document.getElementById('stickerBtn'),
  stickerMenu: document.getElementById('stickerMenu'),
  closeStickerMenu: document.getElementById('closeStickerMenu'),
  stickerGrid: document.getElementById('stickerGrid'),
  nameModal: document.getElementById('nameModal'),
  passwordModal: document.getElementById('passwordModal'),
  nameInput: document.getElementById('nameInput'),
  passwordInput: document.getElementById('passwordInput'),
  roomPrompt: document.getElementById('roomPrompt'),
  sidebar: document.getElementById('sidebar'),
  onlineSidebar: document.getElementById('onlineSidebar'),
  menuBtn: document.getElementById('menuBtn'),
  onlineBtn: document.getElementById('onlineBtn'),
  secretBtn: document.getElementById('secretBtn'),
  roomNameDisplay: document.getElementById('roomNameDisplay'),
  onlineCount: document.getElementById('onlineCount'),
  onlineBadge: document.getElementById('onlineBadge'),
  onlineUsersList: document.getElementById('onlineUsersList'),
  secretContainer: document.getElementById('secretContainer'),
  chatrooms: document.querySelectorAll('.chatroom'),
  navItems: document.querySelectorAll('.nav-item'),
  loading: document.getElementById('loading')
};

// ========== FIREBASE ==========
function initializeFirebase() {
  return new Promise((resolve) => {
    if (typeof firebase === 'undefined') {
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js';
      script.onload = () => {
        const authScript = document.createElement('script');
        authScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js';
        authScript.onload = () => {
          const dbScript = document.createElement('script');
          dbScript.src = 'https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js';
          dbScript.onload = () => {
            try {
              app.firebase = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
              app.database = firebase.database();
              app.auth = firebase.auth();
              console.log('‚úÖ Firebase loaded');
              resolve(true);
            } catch (e) {
              console.warn('Firebase error');
              resolve(false);
            }
          };
          dbScript.onerror = () => resolve(false);
          document.head.appendChild(dbScript);
        };
        authScript.onerror = () => resolve(false);
        document.head.appendChild(authScript);
      };
      script.onerror = () => resolve(false);
      document.head.appendChild(script);
    } else {
      try {
        app.firebase = firebase.initializeApp(CONFIG.FIREBASE_CONFIG);
        app.database = firebase.database();
        app.auth = firebase.auth();
        console.log('‚úÖ Firebase loaded');
        resolve(true);
      } catch (e) {
        resolve(false);
      }
    }
  });
}

// ========== STICKER SYSTEM ==========
function initStickerSystem() {
  elements.stickerBtn.addEventListener('click', () => {
    elements.stickerMenu.style.display = elements.stickerMenu.style.display === 'flex' ? 'none' : 'flex';
  });
  
  elements.closeStickerMenu.addEventListener('click', () => {
    elements.stickerMenu.style.display = 'none';
  });
  
  document.addEventListener('click', (e) => {
    if (!elements.stickerMenu.contains(e.target) && e.target !== elements.stickerBtn) {
      elements.stickerMenu.style.display = 'none';
    }
  });
  
  loadStickers();
}

function loadStickers() {
  elements.stickerGrid.innerHTML = '';
  
  CONFIG.STICKERS.forEach(sticker => {
    const stickerDiv = document.createElement('div');
    stickerDiv.className = 'sticker-item';
    stickerDiv.title = sticker.name;
    
    stickerDiv.innerHTML = `
      <img src="${sticker.file}" alt="${sticker.name}" 
           onerror="this.src='data:image/svg+xml;utf8,<svg xmlns=\"http://www.w3.org/2000/svg\"><rect width=\"100\" height=\"100\" fill=\"%23ff2d2d\"/><text x=\"50\" y=\"60\" font-size=\"40\" fill=\"white\" text-anchor=\"middle\">${sticker.id}</text></svg>'">
    `;
    
    stickerDiv.addEventListener('click', () => {
      console.log(`üéå Selected sticker: ${sticker.name}`);
      sendSticker(sticker.file, sticker.name);
    });
    
    elements.stickerGrid.appendChild(stickerDiv);
  });
  
  console.log(`‚úÖ Loaded ${CONFIG.STICKERS.length} stickers`);
}

function sendSticker(stickerFile, stickerName) {
  if (!currentUser.name) {
    alert('Please enter your name first!');
    elements.nameModal.style.display = 'flex';
    return;
  }
  
  if (!currentUser.room) {
    alert('Please join a room first!');
    return;
  }
  
  console.log(`üéå Sending sticker: ${stickerName}`);
  
  const messageData = {
    type: 'sticker',
    stickerFile: stickerFile,
    stickerName: stickerName,
    senderId: currentUser.id,
    senderName: currentUser.name,
    senderIcon: currentUser.profileIcon, // NEW: Add profile icon
    timestamp: Date.now()
  };
  
  if (app.database && app.database.ref) {
    app.database.ref('rooms/' + currentUser.room + '/messages').push(messageData)
      .then(() => {
        console.log('‚úÖ Sticker sent to Firebase');
        elements.stickerMenu.style.display = 'none';
      })
      .catch(error => {
        console.warn('Failed to send sticker:', error);
        addMessageToUI(messageData);
        elements.stickerMenu.style.display = 'none';
      });
  } else {
    addMessageToUI(messageData);
    elements.stickerMenu.style.display = 'none';
  }
}

// ========== MESSAGE SYSTEM ==========
function initMessageSystem() {
  elements.sendButton.addEventListener('click', function() {
    // Button animation
    this.style.transform = 'scale(0.95)';
    setTimeout(() => {
      this.style.transform = 'scale(1)';
    }, 150);
    sendMessage();
  });
  
  elements.messageInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      // Send button animation
      elements.sendButton.style.transform = 'scale(0.95)';
      setTimeout(() => {
        elements.sendButton.style.transform = 'scale(1)';
      }, 150);
      sendMessage();
    }
  });
}

function sendMessage() {
  const text = elements.messageInput.value.trim();
  if (!text) return;
  
  if (!currentUser.name) {
    alert('Please enter your name first!');
    elements.nameModal.style.display = 'flex';
    return;
  }
  
  console.log(`üí¨ Sending: ${text}`);
  
  const messageData = {
    text: text,
    senderId: currentUser.id,
    senderName: currentUser.name,
    senderIcon: currentUser.profileIcon, // NEW: Add profile icon
    timestamp: Date.now(),
    type: 'text'
  };
  
  if (app.database && app.database.ref) {
    app.database.ref('rooms/' + currentUser.room + '/messages').push(messageData)
      .then(() => {
        elements.messageInput.value = '';
        elements.messageInput.focus();
      })
      .catch(error => {
        console.warn('Failed to send:', error);
        addMessageToUI(messageData);
        elements.messageInput.value = '';
        elements.messageInput.focus();
      });
  } else {
    addMessageToUI(messageData);
    elements.messageInput.value = '';
    elements.messageInput.focus();
  }
}

// ========== ROOM SYSTEM ==========
let messageListener = null;

function loadMessages() {
  elements.loading.style.display = 'block';
  elements.messages.innerHTML = '';
  
  if (messageListener && app.database) {
    app.database.ref('rooms/' + currentUser.room + '/messages').off('value', messageListener);
  }
  
  if (app.database && app.database.ref) {
    const messagesRef = app.database.ref('rooms/' + currentUser.room + '/messages');
    
    messageListener = messagesRef.orderByChild('timestamp').limitToLast(50).on('value', (snapshot) => {
      elements.loading.style.display = 'none';
      elements.messages.innerHTML = '';
      
      if (snapshot.exists()) {
        const messages = [];
        snapshot.forEach(child => {
          messages.push({
            id: child.key,
            ...child.val()
          });
        });
        
        messages.sort((a, b) => a.timestamp - b.timestamp);
        messages.forEach(msg => addMessageToUI(msg));
        
        // FIXED: IMPROVED SCROLL TO BOTTOM
        setTimeout(scrollToBottom, 200);
      } else {
        showSystemMessage(`Welcome to ${currentUser.room}! Be the first to send a message.`);
      }
    }, (error) => {
      console.warn('Load error:', error);
      showDemoMessages();
    });
  } else {
    showDemoMessages();
  }
}

// FIXED: IMPROVED SCROLL FUNCTION
function scrollToBottom() {
  const container = elements.chatContainer;
  const messages = elements.messages;
  
  // Method 1: Direct scroll
  container.scrollTop = container.scrollHeight;
  
  // Method 2: Force scroll after a delay
  setTimeout(() => {
    container.scrollTo({
      top: container.scrollHeight,
      behavior: 'smooth'
    });
  }, 100);
  
  // Method 3: Additional check
  setTimeout(() => {
    if (container.scrollTop + container.clientHeight < container.scrollHeight - 50) {
      container.scrollTop = container.scrollHeight;
    }
  }, 300);
}

function showDemoMessages() {
  elements.loading.style.display = 'none';
  elements.messages.innerHTML = '';
  
  const demoMessages = [
    { 
      senderName: "System", 
      senderIcon: "‚öôÔ∏è",
      text: "Welcome to AnimeChat Pro!", 
      timestamp: Date.now() - 60000 
    },
    { 
      senderName: "Bot", 
      senderIcon: "ü§ñ",
      text: "Connect to internet for real-time chat with other users!", 
      timestamp: Date.now() - 30000 
    },
    { 
      senderName: "Admin", 
      senderIcon: "üëë",
      text: "Send messages, stickers & enjoy!", 
      timestamp: Date.now() 
    }
  ];
  
  demoMessages.forEach(msg => {
    addMessageToUI(msg);
  });
  
  // FIXED: Scroll after demo messages
  setTimeout(scrollToBottom, 500);
}

function addMessageToUI(message) {
  const isSentByMe = message.senderId === currentUser.id;
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${isSentByMe ? 'sent' : 'received'}`;
  
  const time = new Date(message.timestamp).toLocaleTimeString([], { 
    hour: '2-digit', minute: '2-digit' 
  });
  
  // NEW: Add profile icon to sender name
  const senderIcon = message.senderIcon || CONFIG.USER_IMAGES[0];
  
  let content = '';
  if (message.type === 'sticker') {
    content = `
      <div style="text-align:center;padding:8px;">
        <img src="${message.stickerFile}" alt="${message.stickerName}" 
             style="max-width:130px;max-height:130px;border-radius:12px;border:2px solid rgba(255,255,255,0.15);"
             onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=\"color:#ff2d2d;padding:12px;background:rgba(255,45,45,0.1);border-radius:12px;border:2px dashed rgba(255,45,45,0.3)\">üéå ${message.stickerName}</div>';">
        <div style="font-size:12px;opacity:0.8;margin-top:8px;background:rgba(255,255,255,0.07);padding:4px 10px;border-radius:12px;">${message.stickerName}</div>
      </div>
    `;
  } else {
    content = message.text || '';
  }
  
  messageDiv.innerHTML = `
    <div class="sender-name">
      <div class="user-badge">
        <div class="user-avatar-small">${senderIcon}</div>
        <span>${message.senderName || 'Unknown'} ${isSentByMe ? '<span style="color:#25d366;font-size:10px">(You)</span>' : ''}</span>
      </div>
      <span class="message-time">${time}</span>
    </div>
    <div style="font-size:15px;line-height:1.5;">${content}</div>
  `;
  
  elements.messages.appendChild(messageDiv);
  
  // FIXED: IMPROVED AUTO SCROLL TO BOTTOM
  setTimeout(scrollToBottom, 50);
}

function showSystemMessage(text) {
  const messageDiv = document.createElement('div');
  messageDiv.className = 'message received';
  messageDiv.style.background = 'rgba(255, 45, 45, 0.12)';
  messageDiv.style.border = '2px dashed rgba(255, 45, 45, 0.4)';
  messageDiv.innerHTML = `
    <div class="sender-name">
      <div class="user-badge">
        <div class="user-avatar-small" style="background:linear-gradient(135deg,#ff9500,#ff5500)">‚öôÔ∏è</div>
        <span style="color:#ff2d2d;font-weight:bold;">System</span>
      </div>
      <span class="message-time">${new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}</span>
    </div>
    <div style="font-size:14px;color:rgba(255,255,255,0.9);">${text}</div>
  `;
  elements.messages.appendChild(messageDiv);
  
  // FIXED: Scroll after system message
  setTimeout(scrollToBottom, 100);
}

// ========== ROOM MANAGEMENT ==========
function initRoomSystem() {
  elements.chatrooms.forEach(room => {
    room.addEventListener('click', () => {
      const roomName = room.getAttribute('data-room');
      const password = room.getAttribute('data-password');
      const bgFile = room.getAttribute('data-bg');
      
      if (roomName === currentUser.room) {
        elements.sidebar.classList.remove('show');
        return;
      }
      
      if (password) {
        showPasswordModal(roomName, password, bgFile);
      } else {
        switchRoom(roomName, bgFile);
      }
    });
  });
}

function showPasswordModal(roomName, requiredPassword, bgFile) {
  elements.roomPrompt.textContent = `Enter password for "${roomName}":`;
  elements.passwordModal.style.display = 'flex';
  elements.passwordInput.focus();
  elements.passwordInput.value = '';
  
  elements.passwordModal.dataset.room = roomName;
  elements.passwordModal.dataset.password = requiredPassword;
  elements.passwordModal.dataset.bg = bgFile;
}

function switchRoom(roomName, bgFile) {
  console.log(`üö™ Switching to room: ${roomName}`);
  
  elements.messages.innerHTML = '<div class="loading">Loading messages</div>';
  
  currentUser.room = roomName;
  elements.roomNameDisplay.textContent = roomName;
  
  elements.chatrooms.forEach(room => {
    room.classList.remove('active');
    if (room.getAttribute('data-room') === roomName) {
      room.classList.add('active');
    }
  });
  
  if (bgFile) {
    document.getElementById('animeBg').style.backgroundImage = `url('${bgFile}')`;
  }
  
  loadMessages();
  
  elements.sidebar.classList.remove('show');
  
  setTimeout(() => {
    showSystemMessage(`Welcome to ${roomName}! Start chatting now.`);
  }, 500);
}

// ========== USER SYSTEM ==========
function initializeUser() {
  currentUser.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  
  // NEW: Random profile icon for user
  const randomIconIndex = Math.floor(Math.random() * CONFIG.USER_IMAGES.length);
  currentUser.profileIcon = CONFIG.USER_IMAGES[randomIconIndex];
  
  console.log('‚úÖ User registered:', currentUser.name, 'ID:', currentUser.id, 'Icon:', currentUser.profileIcon);
  
  updateOnlineStatus();
  
  loadMessages();
  
  setTimeout(() => {
    elements.messageInput.focus();
    showSystemMessage(`Welcome ${currentUser.name}! You joined ${currentUser.room}.`);
  }, 500);
}

function updateOnlineStatus() {
  if (!currentUser.id || !currentUser.name || !app.database) return;
  
  const userStatusRef = app.database.ref('status/' + currentUser.id);
  
  userStatusRef.set({
    name: currentUser.name,
    online: true,
    lastSeen: Date.now(),
    room: currentUser.room,
    userId: currentUser.id,
    profileIcon: currentUser.profileIcon // NEW: Save profile icon
  });
  
  userStatusRef.onDisconnect().update({
    online: false,
    lastSeen: Date.now()
  });
  
  // Listen for other users
  app.database.ref('status').on('value', (snapshot) => {
    const users = [];
    let onlineCount = 0;
    
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const user = child.val();
        if (user.online && user.userId !== currentUser.id) {
          users.push(user);
          onlineCount++;
        }
      });
    }
    
    // Update online counters
    elements.onlineBadge.textContent = onlineCount;
    elements.onlineCount.textContent = onlineCount + ' online';
    
    // Update online users list WITH PROFILE IMAGES
    if (users.length === 0) {
      elements.onlineUsersList.innerHTML = '<div class="loading">No other users online</div>';
    } else {
      let html = '';
      users.forEach(user => {
        const userIcon = user.profileIcon || CONFIG.USER_IMAGES[0];
        html += `
          <div class="online-user">
            <div class="user-avatar">${userIcon}</div>
            <div class="user-info">
              <strong>${user.name}</strong>
              <small>
                <i class="fas fa-comment" style="color:#ff2d2d"></i> In: 
                <span class="room-indicator">${user.room || 'general'}</span>
              </small>
            </div>
          </div>
        `;
      });
      elements.onlineUsersList.innerHTML = html;
    }
  });
}

// ========== UI SYSTEMS ==========
function initSidebarSystem() {
  let activeSidebar = null;
  
  function toggleSidebar(sidebar) {
    if (activeSidebar === sidebar) {
      sidebar.classList.remove('show');
      activeSidebar = null;
    } else {
      if (activeSidebar) activeSidebar.classList.remove('show');
      sidebar.classList.add('show');
      activeSidebar = sidebar;
    }
    
    elements.stickerMenu.style.display = 'none';
    elements.secretContainer.style.display = 'none';
  }
  
  elements.menuBtn.addEventListener('click', () => toggleSidebar(elements.sidebar));
  elements.onlineBtn.addEventListener('click', () => toggleSidebar(elements.onlineSidebar));
  
  document.addEventListener('click', (e) => {
    if (activeSidebar && 
        !activeSidebar.contains(e.target) && 
        e.target !== elements.menuBtn && 
        e.target !== elements.onlineBtn) {
      activeSidebar.classList.remove('show');
      activeSidebar = null;
    }
  });
}

function initSecretPanel() {
  elements.secretBtn.addEventListener('click', () => {
    const isVisible = elements.secretContainer.style.display === 'block';
    elements.secretContainer.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
      // FIXED: Show actual passwords
      document.getElementById('secretPass1').textContent = CONFIG.SECRET_PASSWORDS.Chatroom1;
      document.getElementById('secretPass2').textContent = CONFIG.SECRET_PASSWORDS.Chatroom2;
      document.getElementById('secretPass3').textContent = CONFIG.SECRET_PASSWORDS.Chatroom3;
      document.getElementById('secretPass4').textContent = CONFIG.SECRET_PASSWORDS.Chatroom4;
      document.getElementById('secretPass5').textContent = CONFIG.SECRET_PASSWORDS.Chatroom5;
    }
  });
  
  document.addEventListener('click', (e) => {
    if (!elements.secretContainer.contains(e.target) && e.target !== elements.secretBtn) {
      elements.secretContainer.style.display = 'none';
    }
  });
}

// ========== EVENT LISTENERS ==========
function initEventListeners() {
  // NAME SUBMISSION - FIXED: Only ask new users
  document.getElementById('submitName').addEventListener('click', () => {
    currentUser.name = elements.nameInput.value.trim();
    if (!currentUser.name) {
      currentUser.name = 'AnimeFan' + Math.floor(Math.random() * 1000);
    }
    
    if (currentUser.name) {
      // Save name to localStorage
      localStorage.setItem('animechat_username', currentUser.name);
      // Mark that user has entered name in THIS SESSION
      sessionStorage.setItem('animechat_name_entered', 'true');
      
      elements.nameModal.style.display = 'none';
      document.title = currentUser.name + ' - AnimeChat Pro';
      
      initializeFirebase().then(firebaseLoaded => {
        if (firebaseLoaded) {
          initializeUser();
        } else {
          currentUser.id = 'offline_' + Date.now();
          showSystemMessage(`Welcome ${currentUser.name}! (Offline Mode)`);
          loadMessages();
        }
      });
    }
  });
  
  elements.nameInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitName').click();
    }
  });
  
  // PASSWORD SUBMISSION
  document.getElementById('submitPassword').addEventListener('click', () => {
    const roomName = elements.passwordModal.dataset.room;
    const requiredPassword = elements.passwordModal.dataset.password;
    const bgFile = elements.passwordModal.dataset.bg;
    const enteredPassword = elements.passwordInput.value.trim().toUpperCase();
    
    if (enteredPassword === requiredPassword) {
      switchRoom(roomName, bgFile);
      elements.passwordModal.style.display = 'none';
      elements.passwordInput.value = '';
    } else {
      alert('‚ùå Wrong password! Try again.');
      elements.passwordInput.focus();
    }
  });
  
  document.getElementById('cancelPassword').addEventListener('click', () => {
    elements.passwordModal.style.display = 'none';
    elements.passwordInput.value = '';
  });
  
  elements.passwordInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      document.getElementById('submitPassword').click();
    }
  });
  
  // NAVIGATION
  elements.navItems.forEach(item => {
    item.addEventListener('click', () => {
      elements.navItems.forEach(nav => nav.classList.remove('active'));
      item.classList.add('active');
      
      const tab = item.getAttribute('data-tab');
      if (tab === 'rooms') {
        elements.sidebar.classList.add('show');
      } else if (tab === 'online') {
        elements.onlineSidebar.classList.add('show');
      } else if (tab === 'theme') {
        const bgFiles = ['background.png', 'bg1.png', 'bg2.png', 'bg3.png', 'bg4.png', 'bg5.png'];
        const currentBg = document.getElementById('animeBg').style.backgroundImage;
        let currentIndex = 0;
        
        for (let i = 0; i < bgFiles.length; i++) {
          if (currentBg.includes(bgFiles[i])) {
            currentIndex = i;
            break;
          }
        }
        
        const nextIndex = (currentIndex + 1) % bgFiles.length;
        document.getElementById('animeBg').style.backgroundImage = `url('${bgFiles[nextIndex]}')`;
        showSystemMessage(`Theme changed to Background ${nextIndex + 1}`);
      }
    });
  });
  
  // CHAT CONTAINER HEIGHT ADJUSTMENT
  function adjustChatHeight() {
    const headerHeight = document.querySelector('.chat-header').offsetHeight;
    const inputHeight = document.querySelector('.input-area').offsetHeight;
    const navHeight = document.querySelector('.nav-bar').offsetHeight;
    
    elements.chatContainer.style.height = `calc(100vh - ${headerHeight + inputHeight + navHeight}px)`;
  }
  
  adjustChatHeight();
  window.addEventListener('resize', adjustChatHeight);
  window.addEventListener('orientationchange', adjustChatHeight);
  
  // FIXED: INITIAL SCROLL TO BOTTOM ON PAGE LOAD
  setTimeout(scrollToBottom, 1000);
}

// ========== APP INITIALIZATION ==========
async function initializeApp() {
  console.log('üöÄ AnimeChat Pro LOADED');
  
  // FIXED: Check if user already entered name in THIS SESSION
  const savedName = localStorage.getItem('animechat_username');
  const nameEnteredThisSession = sessionStorage.getItem('animechat_name_entered');
  
  if (savedName && nameEnteredThisSession === 'true') {
    // User already entered name in this session - NO MODAL
    currentUser.name = savedName;
    currentUser.id = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    document.title = currentUser.name + ' - AnimeChat Pro';
    
    initializeFirebase().then(firebaseLoaded => {
      if (firebaseLoaded) {
        initializeUser();
      } else {
        currentUser.id = 'offline_' + Date.now();
        showSystemMessage(`Welcome back ${currentUser.name}! (Offline Mode)`);
        loadMessages();
      }
    });
    
    elements.nameModal.style.display = 'none';
  } else {
    // NEW USER or FIRST TIME in this session - SHOW MODAL
    elements.nameModal.style.display = 'flex';
    elements.nameInput.focus();
    elements.nameInput.value = 'AnimeFan' + Math.floor(Math.random() * 1000);
  }
  
  // Initialize all systems
  initStickerSystem();
  initSidebarSystem();
  initSecretPanel();
  initRoomSystem();
  initMessageSystem();
  initEventListeners();
  
  console.log('‚úÖ App initialized successfully');
}

// ========== START APP ==========
document.addEventListener('DOMContentLoaded', initializeApp);

window.hideSecretPanel = () => {
  elements.secretContainer.style.display = 'none';
};

// Utility function to clear session (for testing)
window.clearChatSession = () => {
  localStorage.removeItem('animechat_username');
  sessionStorage.removeItem('animechat_name_entered');
  location.reload();
};
</script>
</body>
</html>